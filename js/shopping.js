const app=Vue.createApp({data(){return{currentStep:0,steps:["查看購物車","填寫資料","完成付款"],checked:!1,checkedNames:[],member_data:{name:"王緯育",email:"service@tibame.com",phone:"0912345678"},spOrderName:"",spOrderEmail:"",spOrderPhone:"",sameMemberChecked:!1,havePoints:100,usePoints:0,usePointsCheck:!0,nowDate:null,orderID:"PT0004",spReadyName:"",spReadyEmail:"",spReadyPhone:"",cardNumber:["","","",""],cardDate:["",""],cardCVC:"",isStepTwoValid:!1,validationErrors:[],shoppingItems:[{id:"Car",type:"spDriver",pictureSrc_m:"./images/pic/shop/goShop01_m.png",pictureSrc:"./images/pic/shop/goShop01.png",product:"寵物接送",listType:"轎車",spStepper:!1,spPrice:300,BuyNum:1,listDate_S:"2023/8/17",listDate_E:"2023/8/17",listDate_T:"16:00"},{id:"Hostel1",type:"spHostel",pictureSrc_m:"./images/pic/shop/goShop02_m.png",pictureSrc:"./images/pic/shop/goShop02.png",product:"快樂寵物旅館",listType:"狗套房",dogSize:"小型犬",spStepper:!0,spPrice:800,BuyNum:1,listDate_S:"2023/8/17",listDate_E:"2023/8/20",listDate_T:"16:00"},{id:"Hostel2",type:"spHostel",pictureSrc_m:"./images/pic/shop/goShop03_m.png",pictureSrc:"./images/pic/shop/goShop03.png",product:"快樂寵物旅館",listType:"貓套房",spStepper:!0,spPrice:800,BuyNum:1,listDate_S:"2023/8/17",listDate_E:"2023/8/20",listDate_T:"16:00"}]}},mounted(){this.checked=!0,this.checkedNames=this.shoppingItems.map(e=>e.id);document.getElementById("Go_index").addEventListener("click",()=>{window.location.href="index.html"});this.nowDate=(new Date).toLocaleDateString("zh-TW",{year:"numeric",month:"long",day:"numeric"});var e=this.caculate_point();this.usePoints=e},methods:{sameMember(){!0===this.sameMemberChecked&&(this.spOrderName=this.member_data.name,this.spOrderEmail=this.member_data.email,this.spOrderPhone=this.member_data.phone)},caculate_point(){return this.havePoints<.2*this.totalPrice?this.havePoints:.2*this.totalPrice},setCurrentStep(e){this.currentStep=e},allChecked(){this.checked?this.checkedNames=this.shoppingItems.map(e=>e.id):this.checkedNames=[]},useDate(e){return e.spStepper?(e.listDate_D=Math.round((new Date(e.listDate_E)-new Date(e.listDate_S))/864e5),`${this.formatDate(e.listDate_S)} - ${this.formatDate(e.listDate_E)} (${e.listDate_D}晚)`):this.formatDate(e.listDate_S)+" ｜ "+e.listDate_T},updateSubtotal(e){e.spStepper?e.listDate_D=Math.round((new Date(e.listDate_E)-new Date(e.listDate_S))/864e5):e.listDate_D=1,e.spSubtotal=e.spPrice*e.BuyNum*e.listDate_D},countSubtotal(e){return e.spStepper?e.listDate_D=Math.round((new Date(e.listDate_E)-new Date(e.listDate_S))/864e5):e.listDate_D=1,e.spPrice*e.BuyNum*e.listDate_D},updateAmount(e,t){e.BuyNum<9?e.BuyNum=Math.max(1,e.BuyNum+t):9<=e.BuyNum&&(e.BuyNum=8,e.BuyNum=Math.max(1,e.BuyNum+t)),this.updateSubtotal(e)},handleInput(e){e.BuyNum<1?e.BuyNum=1:9<e.BuyNum&&(e.BuyNum=9),this.updateSubtotal(e)},formatDate(e){var[,e,t]=e.split("/");return`${Number(e)}月${Number(t)}日`},confirmDelete(e){confirm("確認移除嗎？")&&(this.shoppingItems.splice(e,1),this.updateIndex())},updateIndex(){this.shoppingItems.forEach((e,t)=>{e.index=t})},goToIndex(){window.location.href="index.html"},handleCC(e,t){this.$refs["input"+e].value.length===t?e<7&&this.$refs["input"+(e+1)].focus():0===this.$refs["input"+e].value.length&&1<e&&this.$refs["input"+(e-1)].focus();t=this.$refs["input"+e].value;/^\d*$/.test(t)||(this.$refs["input"+e].value=t.replace(/\D/g,""))},checkform(){let t=!0,s=!1;""===this.spOrderName.trim()&&(t=!1,alert("姓名欄位不可為空值")),this.validateEmail(this.spOrderEmail)||(t=!1,alert("請輸入正確的E-mail格式，例:XXX@XXX.XXX")),this.validatePhone(this.spOrderPhone)||(t=!1,alert("請輸入正確的行動電話格式，例:09XXXXXXXX"));for(let e=0;e<this.cardNumber.length;e++)""!==this.cardNumber[e].trim()&&4===this.cardNumber[e].length||(t=!1,s)||(alert("請確認信用卡『欄位填寫』是否正確"),s=!0);this.validateCardDate()||(t=!1,alert("請確認信用卡有效期限是否正確")),3!==this.cardCVC.length&&(t=!1),this.validateCreditCard(this.cardNumber)||(t=!1,alert("請確認信用卡『卡號』是否正確")),t&&this.currentStep++},validateEmail(e){return/^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z]+$/.test(e)},validatePhone(e){return/^09\d{8}$/.test(e)},validateCreditCard(e){var s=e.join("").replace(/[-\s]/g,"");let i=0,a=!1;for(let t=s.length-1;0<=t;t--){let e=parseInt(s.charAt(t),10);a&&9<(e*=2)&&(e-=9),i+=e,a=!a}return i%10==0},validateCardDate(){var e=(new Date).getFullYear().toString().slice(-2),t=this.cardDate[0];return!(!/^(0[1-9]|1[0-2])$/.test(t)||(t=this.cardDate[1],!/^\d{2}$/.test(t))||parseInt(t)<parseInt(e))},resetSameMemberChecked(){this.sameMemberChecked=!1},async saveFormDataToDatabase(){try{const t={spOrderName:this.spOrderName,spOrderEmail:this.spOrderEmail,spOrderPhone:this.spOrderPhone,nowDate:this.nowDate,totalPrice:this.totalPrice,usePoints:this.usePoints,shoppingItems:[]};this.shoppingItems.forEach(e=>{t.shoppingItems.push({product:e.product,listDate_S:e.listDate_S,listDate_E:e.listDate_E,listDate_D:e.listDate_D,spPrice:e.spPrice,BuyNum:e.BuyNum,dogSize:e.dogSize,listType:e.listType})}),(await fetch("shopping.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).ok?console.log("資料已成功儲存到資料庫"):console.error("儲存資料到資料庫時出錯")}catch(e){console.error("儲存資料時發生錯誤:",e)}},handlePoints(e){var t,s=this.caculate_point(),e=e.target.value;/^[0-9\b]+$/.test(e)?(t=parseInt(e),this.usePoints=s<t?s.toString():e):this.usePoints=""}},computed:{totalPrice(){return this.shoppingItems.reduce((e,t)=>this.checkedNames.includes(t.id)?e+this.countSubtotal(t):e,0)},payPrice(){return this.totalPrice-this.usePoints},selectedItems(){return this.shoppingItems.filter(e=>this.checkedNames.includes(e.id))}},watch:{checkedNames(e){this.checked=e.length===this.shoppingItems.length}}});app.mount("#spApp");